<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Hellobox HK</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="icon" href="images/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Mukta:300,400,700"
    />
    <link rel="stylesheet" href="fonts/icomoon/style.css" />

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/magnific-popup.css" />
    <link rel="stylesheet" href="css/jquery-ui.css" />
    <link rel="stylesheet" href="css/owl.carousel.min.css" />
    <link rel="stylesheet" href="css/owl.theme.default.min.css" />

    <link rel="stylesheet" href="css/aos.css" />

    <link rel="stylesheet" href="css/style.css" />
    <!-- Add this style in your <head> section -->
    <!-- Add this style in your <head> section (or in your CSS file) -->
    <style>
      @media (max-width: 767.98px) {
        .site-blocks-table {
          width: 100%;
          overflow-x: auto;
        }
        .site-blocks-table table {
          min-width: 480px;
          width: 100%;
          font-size: 15px;
        }
        .product-thumbnail img {
          max-width: 60px;
          height: auto;
        }
        .cart-extra-row table {
          min-width: 0;
          width: 100%;
          font-size: 14px;
        }
        .cart-extra-row td {
          padding: 0.5rem !important;
        }
        .cart-extra-row table td {
          padding: 0.3rem !important;
        }
      }
      @media (max-width: 575.98px) {
        .site-blocks-table table {
          min-width: 360px;
          font-size: 13px;
        }
      }
      .table.table-bordered th,
      .table.table-bordered td {
        padding-top: 0.4rem !important;
        padding-bottom: 0.4rem !important;
        vertical-align: middle !important;
      }
      .product-thumbnail img {
        max-height: 48px;
        height: auto;
      }
      /* Cropper.js styles */
      #cropper-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
      }
      #cropper-modal .modal-content {
        background: #fff;
        padding: 0px;
        border-radius: 8px;
        max-width: 90vw;
        max-height: 90vh;
        text-align: center;
      }
      #cropper-modal img {
        max-width: 60vw;
        max-height: 60vh;
        display: block;
        margin: 0 auto;
      }

      #cart-table-body .cart-photo-preview-each,
      #cart-table-body .cart-photo-preview-each img,
      #cart-table-body [id^="cart-upload-label-"] {
        display: inline-block;
        vertical-align: middle;
        text-align: left;
      }

      #cart-table-body td {
        text-align: left;
      }

      .product-thumbnail {
        vertical-align: middle;
        text-align: center !important;
      }
      .product-thumbnail img {
        display: inline-block;
        vertical-align: middle;
        max-height: 48px;
        height: auto;
      }

      /* Hide the file input's file description (filename) */
      input[type="file"].cart-photo-each {
        width: 90px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: transparent;
      }

      input[type="file"].cart-photo-each::-webkit-file-upload-button {
        visibility: visible;
      }

      input[type="file"].cart-photo-each::file-selector-button {
        visibility: visible;
      }

      input[type="file"].cart-photo-each::-ms-value {
        display: none;
        color: transparent;
      }
    </style>
  </head>
  <body>
    <div class="site-wrap">
      <header class="site-navbar" role="banner">
        <div class="site-navbar-top">
          <div class="container">
            <div class="row align-items-center">
              <div
                class="col-6 col-md-4 order-2 order-md-1 site-search-icon text-left"
              >
                <form action="" class="site-block-top-search">
                  <!-- <span class="icon icon-search2"></span>
                  <input
                    type="text"
                    class="form-control border-0"
                    placeholder="Search"
                  /> -->
                </form>
              </div>

              <div
                class="col-12 mb-3 mb-md-0 col-md-4 order-1 order-md-2 text-center"
              >
                <div class="site-logo">
                  <a href="index.html" class="js-logo-clone">HELLOBOX HK</a>
                </div>
              </div>

              <div class="col-6 col-md-4 order-3 order-md-3 text-right">
                <div class="site-top-icons">
                  <ul>
                    <!-- <li><a href="#"><span class="icon icon-person"></span></a></li>
                  <li><a href="#"><span class="icon icon-heart-o"></span></a></li> -->
                    <li>
                      <a href="cart.html" class="site-cart">
                        <span class="icon icon-shopping_cart"></span>
                        <span id="cart-count" class="count">0</span>
                      </a>
                    </li>
                    <li class="d-inline-block d-md-none ml-md-0">
                      <a href="#" class="site-menu-toggle js-menu-toggle"
                        ><span class="icon-menu"></span
                      ></a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <nav
          class="site-navigation text-right text-md-center"
          role="navigation"
        >
          <div class="container">
            <ul class="site-menu js-clone-nav d-none d-md-block">
              <li class="">
                <a href="index.html">Home</a>
                <!-- <ul class="dropdown">
                  <li><a href="#">Menu One</a></li>
                  <li><a href="#">Menu Two</a></li>
                  <li><a href="#">Menu Three</a></li>
                  <li class="has-children">
                    <a href="#">Sub Menu</a>
                    <ul class="dropdown">
                      <li><a href="#">Menu One</a></li>
                      <li><a href="#">Menu Two</a></li>
                      <li><a href="#">Menu Three</a></li>
                    </ul>
                  </li>
                </ul> -->
              </li>
              <li class="">
                <a href="about.html">About</a>
                <!-- <ul class="dropdown">
                  <li><a href="#">Menu One</a></li>
                  <li><a href="#">Menu Two</a></li>
                  <li><a href="#">Menu Three</a></li>
                </ul> -->
              </li>
              <li><a href="shop.html">Shop</a></li>
              <!-- <li><a href="#">Catalogue</a></li>
              <li><a href="#">New Arrivals</a></li> -->
              <!-- <li><a href="contact.html">Contact</a></li> -->
            </ul>
          </div>
        </nav>
      </header>

      <div class="bg-light py-3">
        <div class="container">
          <div class="row">
            <div class="col-md-12 mb-0">
              <a href="index.html">Home</a> <span class="mx-2 mb-0">/</span>
              <a href="shop.html">Shop</a> <span class="mx-2 mb-0">/</span>
              <strong class="text-black">Cart</strong>
            </div>
          </div>
        </div>
      </div>

      <div class="site-section">
        <div class="container">
          <div class="row mb-5">
            <form class="col-md-12" method="post">
              <div class="site-blocks-table">
                <table class="table table-bordered">
                  <thead>
                    <!-- <tr>
                      <th class="product-thumbnail">Product</th>
                      <th class="product-price" style="width: 70px">Price</th>
                      <th class="product-remove"></th>
                    </tr> -->
                  </thead>
                  <tbody id="cart-table-body">
                    <!-- Cart items will be injected here by JS -->
                  </tbody>
                </table>
              </div>
            </form>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="row mb-5">
                <div class="col-md-6 mb-3 mb-md-0">
                  <!-- <button class="btn btn-primary btn-sm btn-block">
                    Update Cart
                  </button> -->
                </div>
                <div class="col-md-6">
                  <!-- <button class="btn btn-outline-primary btn-sm btn-block">
                    Continue Shopping
                  </button> -->
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <label class="text-black h4" for="coupon">Coupon</label>
                  <p>Enter your coupon code if you have one.</p>
                </div>
                <div class="col-md-8 mb-3 mb-md-0">
                  <input
                    type="text"
                    class="form-control py-3"
                    id="coupon"
                    placeholder="Coupon Code"
                  />
                </div>
                <div class="col-md-4">
                  <button class="btn btn-primary btn-sm">Apply Coupon</button>
                </div>
              </div>
            </div>
            <div class="col-md-6 pl-5">
              <div class="row justify-content-end">
                <div class="col-md-7">
                  <div class="row">
                    <div class="col-md-12 text-right border-bottom mb-5">
                      <h3 class="text-black h4 text-uppercase">Cart Total</h3>
                    </div>
                  </div>
                  <!-- <div class="row mb-3">
                    <div class="col-md-6">
                      <span class="text-black">Subtotal</span>
                    </div>
                    <div class="col-md-6 text-right">
                      <strong class="text-black">$230.00</strong>
                    </div>
                  </div> -->
                  <div class="row mb-5">
                    <div class="col-md-6">
                      <span class="text-black">Total</span>
                    </div>
                    <div class="col-md-6 text-right">
                      <strong class="text-black" id="cart-total">$0.00</strong>
                      <script>
                        // Update cart total on page load and whenever cart changes
                        function updateCartTotal() {
                          const cart =
                            JSON.parse(localStorage.getItem("cart")) || [];
                          let total = 0;
                          cart.forEach((item) => {
                            total += Number(item.price) || 0;
                          });
                          document.getElementById(
                            "cart-total"
                          ).textContent = `$${total}`;
                        }
                        document.addEventListener(
                          "DOMContentLoaded",
                          updateCartTotal
                        );
                        window.addEventListener("storage", function (e) {
                          if (e.key === "cart") updateCartTotal();
                        });
                      </script>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-12">
                      <button
                        class="btn btn-primary btn-lg py-3 btn-block"
                        onclick="window.location='checkout.html'"
                      >
                        Proceed To Checkout
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="site-footer border-top">
        <div class="container">
          <div class="row pt-5 mt-5 text-center">
            <div class="col-md-12">
              <p>
                <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                Copyright &copy;
                <script>
                  document.write(new Date().getFullYear());
                </script>
                All rights reserved | This template is made with
                <i class="icon-heart" aria-hidden="true"></i> by
                <a
                  href="https://colorlib.com"
                  target="_blank"
                  class="text-primary"
                  >Colorlib</a
                >
                <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
              </p>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/aos.js"></script>

    <script src="js/main.js"></script>
    <script>
      const cloudName = "helloboxhk";
      const uploadPreset = "hellobox_unsigned";

      async function uploadImage(file) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", uploadPreset);
        const res = await fetch(
          `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,
          {
            method: "POST",
            body: formData,
          }
        );
        const data = await res.json();
        return data.secure_url;
      }

      document.addEventListener("DOMContentLoaded", function () {
        function renderCart() {
          const cart = JSON.parse(localStorage.getItem("cart")) || [];
          const tbody = document.getElementById("cart-table-body");
          let html = "";
          let total = 0;

          if (cart.length === 0) {
            html = `<tr><td colspan="7" class="text-center">Your cart is empty.</td></tr>`;
          } else {
            cart.forEach((item, idx) => {
              const itemTotal = item.price;
              total += itemTotal;
              const extras = item.extras || {};
              html += `
                        <tr data-id="${
                          item.id
                        }" style="background-color: #e6f9ff;">
                        <td class="product-thumbnail">
                          ${item.title} <br />
                          <img src="${item.image}" alt="${
                item.title
              }" class="img-fluid" style="max-width:70px;"/>
                        </td>
                        <td>$${item.price}</td>
                        <td class="text-left">
                            <a href="#" class="btn btn-secondary cart-remove" data-idx="${idx}">X</a>
                        </td>
                      </tr>
                      <tr class="cart-extra-row" data-parent-idx="${idx}">
                        <td colspan="3">
                          <table class="table table-bordered mb-2" style="background:#f9f9f9;">
                            <tr>
                              <td style="width:120px; text-align:left;">Photo upload:</td>
                              <td>
                                <input type="file" accept="image/*" class="cart-photo-each" data-idx="${idx}" />
                                <br />
                                <input type="hidden" class="cart-photo-url-each" data-idx="${idx}" value="${
                extras.photoUrl || ""
              }" />
                                <span id="cart-photo-preview-each-${idx}">
                                  ${
                                    extras.photoUrl
                                      ? `<img src="${extras.photoUrl}" style="max-width:60px;max-height:60px;">`
                                      : ""
                                  }
                                </span>
                                <br />
                                <!-- Replace the upload button with a label span and give it an id for dynamic updates -->
                                <span id="cart-upload-label-${idx}" class="text-muted" style="font-size: 0.95em;">${
                extras.photoUrl ? "已上載" : ""
              }</span>
                              </td>
                            </tr>
                            <tr>
                              <td style="text-align:left;">YouTube music link:</td>
                              <td>
                                <input type="url" class="form-control cart-youtube-each" placeholder="YouTube 連結" data-idx="${idx}" value="${
                extras.youtube || ""
              }" />
                              </td>
                            </tr>
                            <tr>
                              <td style="text-align:left;">Voice note:</td>
                              <td>
                                <span class="text-muted">Please upload via WhatsApp after checkout</span>
                              </td>
                            </tr>
                          </table>
                          <br />
                        </td>
                      </tr>
                    `;
            });
          }
          tbody.innerHTML = html;
          // Update total
          const totalElem = document
            .querySelector(".text-black.h4.text-uppercase")
            ?.parentElement?.nextElementSibling?.querySelector(
              "strong.text-black"
            );
          if (totalElem) totalElem.textContent = `$${total}`;
        }

        // Add this script after renderCart() and after any cart update logic

        function updateCartCount() {
          const cart = JSON.parse(localStorage.getItem("cart")) || [];

          const countElemById = document.getElementById("cart-count");
          const countElem =
            countElemById || document.querySelector(".site-cart .count");

          console.log("Cart count:", cart.length);
          if (countElem) {
            if (cart.length > 0) {
              countElem.textContent = cart.length;
              countElem.style.display = "inline-block";
            } else {
              countElem.style.display = "none";
            }
          }
        }

        // Add this after your updateCartCount() function

        // Listen for localStorage changes (from other tabs/windows)
        window.addEventListener("storage", function (e) {
          if (e.key === "cart") {
            updateCartCount();
          }
        });

        // Optionally, also update on focus (in case of changes in other tabs)
        window.addEventListener("focus", function () {
          updateCartCount();
        });

        // Handle quantity change and remove
        document
          .getElementById("cart-table-body")
          .addEventListener("click", async function (e) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            if (e.target.classList.contains("cart-remove")) {
              e.preventDefault();
              const idx = +e.target.getAttribute("data-idx");
              // After removing an item
              cart.splice(idx, 1);
              localStorage.setItem("cart", JSON.stringify(cart));
              renderCart();
              updateCartCount(); // <-- Add this
              // Refresh total amount after removing item
              if (typeof updateCartTotal === "function") updateCartTotal();
            }
            if (e.target.classList.contains("cart-upload-btn-each")) {
              e.preventDefault();
              const idx = +e.target.getAttribute("data-idx");
              const fileInput = document.querySelector(
                `.cart-photo-each[data-idx="${idx}"]`
              );
              const photoUrlInput = document.querySelector(
                `.cart-photo-url-each[data-idx="${idx}"]`
              );
              if (fileInput && fileInput.files[0]) {
                e.target.textContent = "上傳中...";
                const url = await uploadImage(fileInput.files[0]);
                photoUrlInput.value = url;
                // After uploading a photo
                cart[idx].extras = cart[idx].extras || {};
                cart[idx].extras.photoUrl = url;
                localStorage.setItem("cart", JSON.stringify(cart));
                updateCartCount(); // <-- Add this
                document.getElementById(
                  `cart-photo-preview-each-${idx}`
                ).innerHTML = `<img src="${url}" style="max-width:60px;max-height:60px;">`;
                e.target.textContent = "已上傳";
              } else {
                alert("請先選擇圖片");
              }
            }
          });

        document
          .getElementById("cart-table-body")
          .addEventListener("change", function (e) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            if (e.target.classList.contains("cart-photo-each")) {
              const idx = +e.target.getAttribute("data-idx");
              const file = e.target.files[0];
              if (file) {
                cropperFileInput = e.target;
                cropperIdx = idx;
                const reader = new FileReader();
                reader.onload = function (ev) {
                  document.getElementById("cropper-image").src =
                    ev.target.result;
                  document.getElementById("cropper-modal").style.display =
                    "flex";
                  if (cropper) cropper.destroy();
                  cropper = new Cropper(
                    document.getElementById("cropper-image"),
                    {
                      aspectRatio: 1,
                      viewMode: 1,
                      movable: true,
                      zoomable: true,
                      rotatable: false,
                      scalable: false,
                      autoCropArea: 1,
                    }
                  );
                };
                reader.readAsDataURL(file);
              }
              // Do NOT update preview here!
            }
            if (e.target.classList.contains("cart-youtube-each")) {
              const idx = +e.target.getAttribute("data-idx");
              cart[idx].extras = cart[idx].extras || {};
              cart[idx].extras.youtube = e.target.value;
              localStorage.setItem("cart", JSON.stringify(cart));
              updateCartCount();
            }
          });

        renderCart();
        updateCartCount(); // <-- This ensures the cart count is correct on page load
      });

      document
        .querySelector(".btn.btn-primary.btn-lg.py-3.btn-block")
        .addEventListener("click", async function (e) {
          e.preventDefault();

          const cart = JSON.parse(localStorage.getItem("cart")) || [];
          if (cart.length === 0) {
            alert("Your cart is empty.");
            return;
          }

          const orderRef = "HB-" + new Date().getTime();
          let message = `Hello 👋 我想訂購 HelloBox\n訂單編號：${orderRef}\n`;

          for (let i = 0; i < cart.length; i++) {
            const item = cart[i];
            const extras = item.extras || {};
            message += `\n🧸 產品 ${i + 1}：\n`;
            message += `名稱：${item.title}\n`;
            message += `價錢：$${item.price}\n`;
            message += `🖼 相片：${
              extras.photoUrl ? extras.photoUrl : "(未上傳)"
            }\n`;
            message += `🎵 YouTube：${
              extras.youtube ? extras.youtube : "(未填)"
            }\n`;
            message += `🎤 語音：請稍後WhatsApp語音\n`;
          }

          message += `\n`;

          const encoded = encodeURIComponent(message);
          window.location.href = `https://wa.me/85263783481?text=${encoded}`;
        });
    </script>
    <!-- Add this in your <head> section for Cropper.js -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
      rel="stylesheet"
    />
    <div id="cropper-modal">
      <div class="modal-content">
        <h5>請裁剪圖片為正方形 (1:1)</h5>
        <img id="cropper-image" src="" alt="Crop image" />
        <div style="margin-top: 10px">
          <button id="cropper-confirm" class="btn btn-primary">
            確定裁剪並上傳
          </button>
          <button id="cropper-cancel" class="btn btn-secondary">取消</button>
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
      let cropper = null;
      let cropperFileInput = null;
      let cropperIdx = null;

      document
        .getElementById("cart-table-body")
        .addEventListener("change", function (e) {
          if (e.target.classList.contains("cart-photo-each")) {
            const idx = +e.target.getAttribute("data-idx");
            const file = e.target.files[0];
            if (file) {
              cropperFileInput = e.target;
              cropperIdx = idx;
              const reader = new FileReader();
              reader.onload = function (ev) {
                document.getElementById("cropper-image").src = ev.target.result;
                document.getElementById("cropper-modal").style.display = "flex";
                if (cropper) cropper.destroy();
                cropper = new Cropper(
                  document.getElementById("cropper-image"),
                  {
                    aspectRatio: 1,
                    viewMode: 1,
                    movable: true,
                    zoomable: true,
                    rotatable: false,
                    scalable: false,
                    autoCropArea: 1,
                  }
                );
              };
              reader.readAsDataURL(file);
            }
          }
        });

      // Cancel cropper
      document.getElementById("cropper-cancel").onclick = function () {
        document.getElementById("cropper-modal").style.display = "none";
        if (cropper) cropper.destroy();
        cropper = null;
        if (cropperFileInput) cropperFileInput.value = ""; // reset file input
      };

      // Confirm crop and upload
      document.getElementById("cropper-confirm").onclick = async function () {
        if (!cropper) return;
        const canvas = cropper.getCroppedCanvas({ width: 800, height: 800 });
        const label = document.getElementById(
          `cart-upload-label-${cropperIdx}`
        );
        if (label) label.textContent = "上傳中...";
        canvas.toBlob(
          async function (blob) {
            // Show preview
            document.getElementById(
              `cart-photo-preview-each-${cropperIdx}`
            ).innerHTML = `<img src="${canvas.toDataURL()}" style="max-width:60px;max-height:60px;">`;
            // Upload to Cloudinary
            document.getElementById("cropper-modal").style.display = "none";
            cropper.destroy();
            cropper = null;

            // Upload
            const url = await uploadImage(blob);

            // Save to cart object in localStorage
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            cart[cropperIdx].extras = cart[cropperIdx].extras || {};
            cart[cropperIdx].extras.photoUrl = url;
            localStorage.setItem("cart", JSON.stringify(cart));

            // Show thumbnail preview
            document.getElementById(
              `cart-photo-preview-each-${cropperIdx}`
            ).innerHTML = `<img src="${url}" style="max-width:60px;max-height:60px;">`;
            if (label) label.textContent = "已上傳";
          },
          "image/jpeg",
          0.92
        );
      };
    </script>

    <script type="module">
      // Import the functions you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
      import {
        getFirestore,
        collection,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyD8dpsml9CpIw28VKYTqOX2QiGki5_H2JQ",
        authDomain: "helloboxhk2025.firebaseapp.com",
        projectId: "helloboxhk2025",
        storageBucket: "helloboxhk2025.firebasestorage.app",
        messagingSenderId: "171867347123",
        appId: "1:171867347123:web:a8c8b5c4744fd1c51138c6",
        measurementId: "G-H18SL4D6ST",
      };
      console.log("aaaaaaa.");
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getFirestore(app); // ✅ Correct way to get Firestore
      console.log("✅ Firebase initialized successfully.");
      // Check Firestore connection by attempting to read a collection
      try {
        const testCollection = collection(db, "promocode");
        const snapshot = await getDocs(testCollection); // ✅ await or .then
        console.log("✅ Firestore connected successfully.");
        console.log(`📦 ${snapshot.size} documents retrieved.`);
      } catch (err) {
        console.error("❌ Firestore connection error:", err);
      }
    </script>
  </body>
</html>
